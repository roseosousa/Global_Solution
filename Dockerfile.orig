FROM rocker/r-ver:4.3.1 AS base

LABEL maintainer="autogenerated"

ARG USER=appuser
ARG UID=1000

# Instalar utilitários e Python
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    python3 python3-pip build-essential libssl-dev libcurl4-openssl-dev libxml2-dev ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copia requisitos e instala dependências Python
COPY requirements.txt /app/requirements.txt
RUN python3 -m pip install --upgrade pip setuptools wheel \
    && python3 -m pip install --no-cache-dir -r /app/requirements.txt

# Copia o código
COPY . /app

# Criar usuário não-root
RUN groupadd -g ${UID} ${USER} \
    && useradd -r -u ${UID} -g ${USER} -d /app -s /sbin/nologin ${USER} \
    && chown -R ${USER}:${USER} /app

USER ${USER}

EXPOSE 5000

# Comando recomendado para produção (gunicorn já está no requirements)
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "server:app"]